// ignore_for_file: deprecated_member_use

import 'package:flutter/material.dart';
import 'task_model.dart';
import 'task_input_widgets.dart';
import 'date_time_picker_widgets.dart';
import 'api_service.dart';
import 'package:flutter/foundation.dart';

class CreateTaskScreen extends StatefulWidget {
  final Task? existingTask;
  final Function(Task) onTaskCreated;
  final Function(Task)? onTaskUpdated;
  final bool isEditMode;

  const CreateTaskScreen({
    super.key,
    this.existingTask,
    required this.onTaskCreated,
    this.onTaskUpdated,
    this.isEditMode = false,
  });

  @override
  State<CreateTaskScreen> createState() => _CreateTaskScreenState();
}

class _CreateTaskScreenState extends State<CreateTaskScreen> {
  final _formKey = GlobalKey<FormState>();
  final titleController = TextEditingController();
  final descriptionController = TextEditingController();
  double progress = 0.0;
  String selectedStatus = 'To-Do';
  DateTime? selectedDueDate;
  TimeOfDay? startTime;
  TimeOfDay? endTime;

  final List<String> statuses = ['To-Do', 'Progress', 'Done'];

  @override
  void initState() {
    super.initState();
    if (widget.existingTask != null) {
      final task = widget.existingTask!;
      titleController.text = task.title;
      descriptionController.text = task.description;
      selectedStatus = task.status;
      selectedDueDate = task.dueDate;
      startTime = task.startTime;
      endTime = task.endTime;
      progress = (task.progress ?? 0.0) * 100;
    }
  }

  void _submitForm() async {
    // ✅ Validation for empty title/description
    if (titleController.text.trim().isEmpty || descriptionController.text.trim().isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text("Title and Description cannot be empty")),
      );
      return;
    }

    final task = Task(
      title: titleController.text,
      description: descriptionController.text,
      status: selectedStatus,
      dueDate: selectedDueDate ?? DateTime.now(),
      startTime: startTime,
      endTime: endTime,
      progress: selectedStatus == 'Progress' ? (progress / 100) : null,
    );

    if (widget.isEditMode && widget.onTaskUpdated != null) {
      widget.onTaskUpdated!(task);
      if (mounted) Navigator.pop(context, true); // ✅ Notify success
    } else {
      final createdTask = await ApiService.createTask(task);

      if (kDebugMode && createdTask != null) {
        print("Task created: ${createdTask.title}, ID: ${createdTask.id}");
      }

      if (createdTask != null) {
        widget.onTaskCreated(createdTask);
        if (mounted) Navigator.pop(context, true); // ✅ Notify success
      } else {
        if (!mounted) return;
        showDialog(
          context: context,
          builder: (_) => AlertDialog(
            title: const Text("Error"),
            content: const Text("Failed to create task. Please try again."),
            actions: [
              TextButton(
                child: const Text("OK"),
                onPressed: () => Navigator.pop(context),
              )
            ],
          ),
        );
      }
    }
  }

  Future<void> _pickDate() async {
    final DateTime? picked = await showDatePicker(
      context: context,
      initialDate: selectedDueDate ?? DateTime.now(),
      firstDate: DateTime.now(),
      lastDate: DateTime(2101),
      builder: (context, child) {
        return Theme(
          data: Theme.of(context).copyWith(
            colorScheme: const ColorScheme.light(
              primary: Colors.pinkAccent,
              onPrimary: Colors.white,
              onSurface: Colors.black,
            ),
          ),
          child: child!,
        );
      },
    );
    if (picked != null) {
      setState(() => selectedDueDate = picked);
    }
  }

  Future<void> _pickTime({required bool isStart}) async {
    final TimeOfDay? picked = await showTimePicker(
      context: context,
      initialTime: isStart
          ? (startTime ?? TimeOfDay.now())
          : (endTime ?? TimeOfDay.now()),
      initialEntryMode: TimePickerEntryMode.input,
      builder: (context, child) {
        return Theme(
          data: Theme.of(context).copyWith(
            timePickerTheme: TimePickerThemeData(
              hourMinuteTextColor: Colors.black87,
              hourMinuteColor: Colors.white,
              hourMinuteShape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(8),
                side: const BorderSide(color: Colors.grey, width: 1.5),
              ),
              entryModeIconColor: Colors.pinkAccent,
              dialHandColor: Colors.pinkAccent,
              dialBackgroundColor: Colors.white,
            ),
            colorScheme: const ColorScheme.light(
              primary: Colors.pinkAccent,
              onPrimary: Colors.white,
              onSurface: Colors.black,
            ),
          ),
          child: child!,
        );
      },
    );

    if (picked != null) {
      setState(() {
        if (isStart) {
          startTime = picked;
        } else {
          endTime = picked;
        }
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    final isEditing = widget.isEditMode;

    return Scaffold(
      backgroundColor: const Color(0xFFFFC1E3),
      appBar: AppBar(
        backgroundColor: Colors.pinkAccent,
        title: Text(
          isEditing ? "Update Task" : "Create Task",
          style: const TextStyle(color: Colors.white),
        ),
        iconTheme: const IconThemeData(color: Colors.white),
      ),
      body: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(16),
          child: Form(
            key: _formKey,
            child: ListView(
              children: [
                buildLabel("Task Title"),
                styledInput(
                  controller: titleController,
                  hint: "Enter title",
                  isRequired: true,
                ),
                const SizedBox(height: 16),

                buildLabel("Description"),
                styledInput(
                  controller: descriptionController,
                  hint: "Enter description",
                ),
                const SizedBox(height: 16),

                buildLabel("Status"),
                styledDropdown(
                  value: selectedStatus,
                  items: statuses,
                  onChanged: (value) => setState(() => selectedStatus = value!),
                ),
                const SizedBox(height: 16),

                if (selectedStatus == 'Progress') ...[
                  const Text(
                    "Progress (%)",
                    style: TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.w600,
                      color: Colors.black87,
                    ),
                  ),
                  Slider(
                    value: progress,
                    min: 0,
                    max: 100,
                    divisions: 100,
                    label: "${progress.toInt()}%",
                    activeColor: Colors.pinkAccent,
                    onChanged: (value) => setState(() => progress = value),
                  ),
                  const SizedBox(height: 16),
                ],

                buildLabel("Due Date"),
                DatePickerField(
                  selectedDate: selectedDueDate,
                  onTap: _pickDate,
                ),
                const SizedBox(height: 16),

                buildLabel("Start Time"),
                TimePickerField(
                  selectedTime: startTime,
                  onTap: () => _pickTime(isStart: true),
                  label: "Pick Start Time",
                ),
                const SizedBox(height: 16),

                buildLabel("End Time"),
                TimePickerField(
                  selectedTime: endTime,
                  onTap: () => _pickTime(isStart: false),
                  label: "Pick End Time",
                ),
                const SizedBox(height: 30),

                ElevatedButton(
                  onPressed: _submitForm,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.pinkAccent,
                    foregroundColor: Colors.white,
                    padding: const EdgeInsets.symmetric(vertical: 16),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                  ),
                  child: Text(
                    isEditing ? "Update Task" : "Add Task",
                    style: const TextStyle(
                        fontSize: 16, fontWeight: FontWeight.bold),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}
